<% content_for(:page_title, "Filing Schedule") %>

<div class="pb-4">
  <%= link_to "<< Back to Filings / Calendar", filings_path, class: link_class %>
</div>

<div class="bg-white shadow sm:rounded-lg px-6 pb-2 mb-2">

  <div class="text-2xl font-medium mb-2">
    <%= @filing.corporate_name %><br>

    <% if @filing.active? %>
      <span class="text-green-700 text-sm font-medium">Active</span>
    <% else %>
      <span class="text-gray-500 text-sm">
        Inactive –
        Paused since <%= @filing.paused_at.to_formatted_s(:d_usa) %>
      </span>
    <% end %>
  </div>

  <dl class="grid grid-cols-3 lg:grid-cols-5 gap-4 text-base">
    <div>
      <dt class="text-gray-500">Type</dt>
      <dd><%= @filing.filing_type %></dd>
    </div>

    <div>
      <dt class="text-gray-500">Frequency</dt>
      <dd><%= @filing.frequency %></dd>
    </div>

     <div>
      <dt class="text-gray-500">Start Date</dt>
      <dd><%= @filing.start_date.to_formatted_s(:d_usa) %></dd>
    </div>

    <div class="text-center">
      <dt class="text-gray-500">Due Rule</dt>
      <dd>
        <% if @filing.frequency == "Annually" %>
          <%= Date::MONTHNAMES[@filing.month_of_year] %>
          <%= @filing.day_of_month %>
        <% else %>
          Day <%= @filing.day_of_month %> of each month
        <% end %>
      </dd>
    </div>

    <div class="text-right">
      <dt class="text-gray-500">Cost</dt>
      <dd><%= number_to_currency(@filing.cost) %></dd>
    </div>
  </dl>

  <dl class="grid grid-cols-3 lg:grid-cols-5 gap-4 text-base mt-4 border-t pt-4">
    <div>
      <dt class="text-gray-500">Site User ID</dt>
      <dd><%= @filing.site_user_id.presence || "—" %></dd>
    </div>

    <div data-controller="password">
      <dt class="text-gray-500">Site Password</dt>
      <dd class="flex items-center gap-2 font-mono text-sm relative">

        <span data-password-target="masked">••••••••</span>

        <span data-password-target="plain" class="hidden">
          <%= @filing.site_password %>
        </span>

        <button type="button"
                class="text-gray-500 hover:text-blue-700"
                title="Show / hide password"
                data-action="password#toggle">
          <i class="fa-solid fa-eye"></i>
        </button>

        <button type="button"
                class="text-gray-500 hover:text-blue-700"
                title="Copy password"
                data-action="password#copy">
          <i class="fa-solid fa-copy"></i>
        </button>

        <span data-password-target="feedback"
              class="hidden ml-2 text-xs text-green-600 font-medium">
          Copied ✓
        </span>
      </dd>
    </div>

    <div class="text-left col-span-2">
      <dt class="text-gray-500 ">Website</dt>
      <dd>
        <% if @filing.website.present? %>
          <%= link_to @filing.website, @filing.website,
                target: "_blank",
                class: link_class %>
        <% else %>
          <span class="text-gray-400">—</span>
        <% end %>
      </dd>
    </div>

    <div class="text-right">
      <dt class="text-gray-500">Site Email</dt>
      <dd><%= @filing.site_email.presence || "—" %></dd>
    </div>
  </dl>

  <dl class="grid grid-cols-3 lg:grid-cols-5 gap-4 text-base mt-4">
    <div class="text-gray-600">
      <dt>Last Updated At</dt>
      <dd><%= @filing.updated_at.to_formatted_s(:usa_dt) %></dd>
    </div>

    <div class="col-span-3">
      <dt class="text-gray-500">Notes</dt>
      <dd><%= @filing.notes.presence || "—" %></dd>
    </div>

   <div class="text-right self-start">
      <div class="flex justify-end gap-2">
        <%= link_to "Edit",
              edit_filing_path(@filing),
              class: form_button_class + " px-3 py-1.5 text-sm" %>

        <%= button_to "Delete",
              filing_path(@filing),
              method: :delete,
              data: {
                turbo_confirm: "⚠️ Are you sure?\n\nThis will permanently delete this filing and all associated occurrences.\n\nThis action cannot be undone."
              },
              class: red_button_class + " px-3 py-1.5 text-sm" %>
      </div>
    </div>

  </dl>
</div>

<div class="mr-20 text-right">
  <%= button_to "Generate Another Year of Payments Due",
        generate_next_year_filing_path(@filing),
        method: :post,
        data: {
          confirm: "Generate the next year of filing occurrences?"
        },
        class: form_button_class %>
</div>


<!-- OCCURRENCES -->
<div class="bg-white shadow sm:rounded-lg px-20 pt-2">

  <% unless @filing.active? %>
    <div class="mb-2 text-sm text-gray-500">
      Filing paused on <%= @filing.paused_at.to_formatted_s(:d_usa) %>.
      Future occurrences are read-only.
    </div>
  <% end %>

  <!-- Scroll container -->
  <div class="relative overflow-x-auto max-h-[60vh] overflow-y-auto">

    <table class="w-full table-fixed text-left">
      <!-- Sticky header -->
      <thead class="bg-gray-100 text-xs text-gray-700 sticky top-0 z-10 shadow-sm">
        <tr>
          <th class="px-4 py-2 w-40 text-right">Due Date</th>
          <th class="px-4 py-2 w-32 text-center">Status</th>
          <th class="px-4 py-2 w-40">Filed Date</th>
          <th class="px-4 py-2 w-32">Cost</th>
        </tr>
      </thead>

      <tbody>
        <% @occurrences.each do |occ| %>
          <% paused_future =
              !@filing.active? &&
              @filing.paused_at.present? &&
              occ.due_date >= @filing.paused_at %>

          <tr class="border-b
                    <%= paused_future ? 'bg-gray-100 text-gray-400' : 'hover:bg-gray-50' %>">

            <!-- Due date -->
            <td class="px-4 py-3 text-right">
              <%= occ.due_date.to_formatted_s(:d_usa) %>
            </td>

            <!-- Filed checkbox -->
            <td class="px-4 py-3 text-center">
              <%= form_with model: occ,
                    url: filing_occurrence_path(occ),
                    method: :patch,
                    local: true do |f| %>

                <%= f.check_box :filed,
                      disabled: paused_future,
                      class: "w-5 h-5 text-blue-600 border-gray-300 rounded disabled:opacity-50",
                      onchange: "this.form.submit()" %>
              <% end %>
            </td>

            <!-- Filed at date -->
            <td class="px-4 py-3">
              <%= form_with model: occ,
                    url: filing_occurrence_path(occ),
                    method: :patch,
                    local: true do |f| %>

                <%= f.date_field :filed_at,
                      value: occ.filed_at,
                      disabled: paused_future,
                      class: "rounded-md border-gray-300 text-sm disabled:bg-gray-100 disabled:text-gray-400",
                      onchange: "this.form.submit()" %>
              <% end %>
            </td>

            <!-- Cost -->
            <td class="px-4 py-3">
              <%= number_to_currency(occ.cost) %>
            </td>

          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>


